!function(e){var t={init:function(t,n){var r=e.extend({},l,t),a=e.fn.FlexiTable.setData.apply(this,[r,n]);e(this).data("options",r),e.fn.FlexiTable.redraw.apply(this,[r,a])},setData:function(t){e.fn.FlexiTable.setData.apply(this,[e(this).data("options"),t])},getClassName:function(t,l,n){return n||(n=e(this).data("storage")),n.getClass(t,l,!1)},getStorage:function(){return e(this).data("storage")},redraw:function(t){e.fn.FlexiTable.redraw.apply(this,[t])}},l={fields:[],cols:[],rows:[],enableDragAndDrop:!0,onRequestData:null,onSort:null,onChange:null,onRenderCell:null,onRenderHeader:null,onRenderField:null,onAfterRender:null};e.fn.FlexiTable=function(e){return t[e]?t[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void 0:t.init.apply(this,arguments)},e.fn.FlexiTable.setData=function(t,l){var n=e(this),r=l?Array.prototype.slice.call(l,0):[],a=new FlexiTableStorage(r);return 0==t.fields.length?r.forEach(function(e){var l=t.onRequestData?t.onRequestData(e):e;for(var n in l)a.addKey(n)}):t.fields.forEach(function(e){a.addKey(e)}),n.data("storage",a),a},e.fn.FlexiTable.prepareData=function(t,l){l||(l=e(this).data("storage"));var n=e.fn.FlexiTable.prepareTree(t,t.rows,l),r=e.fn.FlexiTable.prepareTree(t,t.cols,l);return t.onSort&&(e.fn.FlexiTable.sortTree(n,t.rows,t.onSort),e.fn.FlexiTable.sortTree(r,t.cols,t.onSort)),{rowTree:n,colTree:r}},e.fn.FlexiTable.prepareTree=function(e,t,l){var n=new TreeNode(null,null);return l.data.forEach(function(l){var r=n,a=e.onRequestData?e.onRequestData(l):l;t.forEach(function(e){r=r.addChild(a[e])})}),n.updateCount(),n},e.fn.FlexiTable.sortTree=function(t,l,n){t.children.length>0&&(t.children=n(l[t.level],t.children)),t.children.forEach(function(t){e.fn.FlexiTable.sortTree(t,l,n)})},e.fn.FlexiTable.getClassesFromNode=function(e,t,l){for(var n=[],r=e;r&&r.level>0;)n.unshift(l.getClass(t.cols[r.level-1],r.value,!0)),r=r.parent;return n},e.fn.FlexiTable.renderFlexiTable=function(t,l){var n=e.fn.FlexiTable.prepareData(t,l),r=t.cols.length>=1?t.cols.length:0,a=t.rows.length>=1?t.rows.length:0,o='<table class="flexitable">';r>0&&a>0&&(o+='<tr><td class="island" rowspan= "'+r+'" colspan= "'+a+'" > </td>');var i=n.colTree.getLevels(),s=[],c=i.length-1;for(var d in i){var f=+d,u=i[f];u.forEach(function(n,r){var a=n.level-1,i=t.cols[a],d=e.fn.FlexiTable.getClassesFromNode(n,t,l),u=d.join(" ");f==c&&(s[r]=u),o+='<td colspan="'+n.count+'" class="colHeader '+u+'">'+(t.onRenderHeader?t.onRenderHeader(i,n.value):n.value)+"</td>"}),o+="</tr><tr>"}var h=n.rowTree.getDeepFirst(),p=[];if(a>0)for(var d in h){var u=h[d];if(0!=u.length){var v=u[0].level;p.splice(v-1),u.forEach(function(e){var n=t.rows[e.level-1],r=l.getClass(n,e.value);p.push(r),o+='<td rowspan="'+e.count+'" class="rowHeader '+p.join(" ")+'">'+(t.onRenderHeader?t.onRenderHeader(n,e.value):e.value)+"</td>"}),c>=0?i[c].forEach(function(e,t){o+='<td class="cell '+p.join(" ")+" "+s[t]+'"></td>'}):o+='<td class="cell '+p.join(" ")+'"></td>',o+="</tr><tr>"}}else c>=0&&i[c].forEach(function(e,t){o+='<td class="cell '+s[t]+'"></td>'}),o+="</tr><tr>";return o=o.substring(0,o.length-5),o+="</table>"},e.fn.FlexiTable.renderFrame=function(t,l){var n=e.fn.FlexiTable.renderFlexiTable(t,l);if(1==t.enableDragAndDrop){var r=l.keys.slice(0),a="",o="";t.cols.forEach(function(e){a+='<li class="field" data-field="'+e+'">'+(t.onRenderField?t.onRenderField(e):e)+"</li>";var l=r.indexOf(e);l>=0&&delete r[l]}),t.rows.forEach(function(e){o+='<li class="field" data-field="'+e+'">'+(t.onRenderField?t.onRenderField(e):e)+"</li>";var l=r.indexOf(e);l>=0&&delete r[l]});var i='<table class="dragFlexitable"><tr><td rowspan="2" class="island"></td><td class="fields"><ul class="sortableField">';r.forEach(function(e){i+='<li class="field" data-field="'+e+'">'+(t.onRenderField?t.onRenderField(e):e)+"</li>"}),i+='</ul></td></tr><tr><td class="columns"><ul class="sortableField">'+a+'</ul></td></tr><tr><td class="rows"><ul class="sortableField">'+o+"</ul></td><td>"+n+"</td></tr></table>"}else i=n;return i};var n;e.fn.FlexiTable.detectChange=function(t,l){n&&clearTimeout(n);var r=e(this);n=setTimeout(function(){var t=r.data("options"),l=r.data("storage");t.cols=[],r.find(".columns > ul > li.field").each(function(l,n){t.cols.push(e(n).data("field"))}),t.rows=[],r.find(".rows > ul > li.field").each(function(l,n){t.rows.push(e(n).data("field"))});var a=e.fn.FlexiTable.renderFlexiTable(t,l);r.find("table.flexitable").replaceWith(a),r.data("options",t),t.onChange&&t.onChange(t.rows,t.cols),e.fn.FlexiTable.renderCells(r,t,l),n=null},100)},e.fn.FlexiTable.renderCells=function(e,t,l){if(t.onRenderCell){var n=l.keys.slice(0);t.cols.forEach(function(e){var t=n.indexOf(e);n.splice(t,1)}),t.rows.forEach(function(e){var t=n.indexOf(e);n.splice(t,1)});var r=[];l.data.forEach(function(e){var n=t.onRequestData?t.onRequestData(e):e,a=[];t.cols.forEach(function(e){var t=l.getClass(e,n[e],!0);a.push("."+t)});var o=[];t.rows.forEach(function(e){var t=l.getClass(e,n[e],!0);o.push("."+t)});var i=a.join(""),s=o.join("");r[s]||(r[s]=[]),r[s][i]?r[s][i].push(e):r[s][i]=[e]});for(var a in r){var o=r[a];for(var i in o){var s=e.find(".cell"+a+i);t.onRenderCell(s,o[i],n,e)}}}t.onAfterRender&&t.onAfterRender(e,l)},e.fn.FlexiTable.redraw=function(t,l){t||(t=e(this).data("options")),l||(l=e(this).data("storage"));var n=e.fn.FlexiTable.renderFrame.apply(this,[t,l]),r=e(this);if(r.html(n),t.enableDragAndDrop){var a=this;r.find(".columns .sortableField, .rows .sortableField").sortable({connectWith:"ul.sortableField",stop:function(t,l){e.fn.FlexiTable.detectChange.apply(a,[t,l])},receive:function(t,l){e.fn.FlexiTable.detectChange.apply(a,[t,l])},remove:function(t,l){e.fn.FlexiTable.detectChange.apply(a,[t,l])}}).disableSelection(),r.find(".fields .sortableField").sortable({connectWith:"ul.sortableField"}).disableSelection()}e.fn.FlexiTable.renderCells(r,t,l)}}(jQuery);var FlexiTableStorage=function(){function e(e){this.keys=[],this.keyLookUp=[],this.data=e,this.classLookUp=[],this.classNumber=1}return e.prototype.addKey=function(e){"undefined"==typeof this.keyLookUp[e]&&(this.keyLookUp[e]=!0,this.keys.push(e))},e.prototype.getClass=function(e,t,l){var n=e+t;if(this.classLookUp[n])return this.classLookUp[n];if(l!==!1){var r="C"+this.classNumber++;return this.classLookUp[n]=r,r}},e}(),TreeNode=function(){function e(e,t){this.parent=e,this.count=0,this.level=e?e.level+1:0,this.children=[],this.childLookUp=[],this.value=t}return e.prototype.addChild=function(t){var l=this.childLookUp[t];if(l)return l;var n=new e(this,t);return this.children.push(n),this.childLookUp[t]=n,n},e.prototype.increment=function(){for(var e=this.parent;e;)e.count++,e=e.parent},e.prototype.updateCount=function(){var e=0;return this.children.forEach(function(t){e+=t.updateCount()}),this.count=0==e?1:e,this.count},e.prototype.getLevels=function(){var e=[];return this.getLevelRecursive(e,this.children),e},e.prototype.getLevelRecursive=function(e,t){t.forEach(function(t){e[t.level]||(e[t.level]=new Array),e[t.level].push(t),t.getLevelRecursive(e,t.children)})},e.prototype.getDeepFirst=function(){var e=[];return e[0]=[],this.getDeepFirstRecursive(e,0,this.children),e.splice(e.length-1),e},e.prototype.getDeepFirstRecursive=function(e,t,l){return 0==l.length?(t++,e[t]=[],t):(l.forEach(function(l){e[t].push(l),t=l.getDeepFirstRecursive(e,t,l.children)}),t)},e}();